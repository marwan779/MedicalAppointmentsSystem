@using MedicalAppointmentsSystem
@using MedicalAppointmentsSystem.Areas.Doctor.Models.ViewModels.UserAppointmentResponse
@using MedicalAppointmentsSystem.Models.ViewModels
@model List<UserAppointmentResponseVM>
@{
    ViewData["Title"] = "Appointment Requests";
    Layout = "_Layout";
}

<div class="container mt-5">
    <h1 class="text-primary mb-4"><i class="fas fa-calendar-check me-2"></i>@ViewData["Title"]</h1>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Patient Requests</h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user me-1"></i> Patient</th>
                                <th><i class="fas fa-calendar-day me-1"></i> Preferred Date</th>
                                <th><i class="fas fa-clock me-1"></i> Requested At</th>
                                <th><i class="fas fa-heartbeat me-1"></i> Chronic Diseases</th>
                                <th><i class="fas fa-comment-medical me-1"></i> Visiting Reason</th>
                                <th><i class="fas fa-file-medical me-1"></i> Documents</th>
                                <th><i class="fas fa-info-circle me-1"></i> Status</th>
                                <th><i class="fas fa-cogs me-1"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model)
                            {
                                <tr>
                                    <td>@request.UserName</td>
                                    <td>@request.PreferredDate.ToString("MMMM dd, yyyy")</td>
                                    <td>@request.RequestedAt.ToString("g")</td>
                                    <td>@request.ChronicDiseases</td>
                                    <td>@request.ComplainsAbout</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(request.DocumentsUrl))
                                        {
                                            <a href="@request.DocumentsUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-file-pdf me-1"></i> View
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">None</span>
                                        }
                                    </td>

                                    <td>
                                        @if (request.RequestStatus == StaticDetails.AppointmentScheduled)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-calendar-check me-1"></i> @request.RequestStatus
                                            </span>
                                        }
                                        else if (request.RequestStatus == StaticDetails.RequestRejected)
                                        {
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i> @request.RequestStatus
                                            </span>
                                        }
                                        else if (request.RequestStatus == StaticDetails.RequestWithdrawn)
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-user-slash me-1"></i> @request.RequestStatus
                                            </span>
                                        }
                                        else if (request.RequestStatus == StaticDetails.RequestUnderReview)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-hourglass-half me-1"></i> @request.RequestStatus
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            @*  <a asp-action="Details" asp-route-id="@request.Id" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i> Details
                                            </a> *@
                                            @if (request.RequestStatus == StaticDetails.RequestUnderReview)
                                            {
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="actionMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Respond
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="actionMenu">
                                                        <li>
                                                            <a class="dropdown-item text-success" asp-action="ScheduleAppointment" asp-route-requestId="@request.Id">
                                                                <i class="fas fa-check-circle me-1"></i> Schedule
                                                            </a>
                                                        </li>
                                                        <li>
                                                            @* <a class="dropdown-item text-danger" asp-action="RejectRequest" asp-route-requestId="@request.Id">
                                                                <i class="fas fa-times-circle me-1"></i> Reject
                                                            </a> *@

                                                            <button onclick="confirmRejectance('@request.Id')"
                                                                    class="dropdown-item text-danger">
                                                                <i class="fas fa-times-circle me-1"></i> Reject
                                                            </button>
                                                        </li>
                                                    </ul>
                                                </div>
                                            }

                                            @if (request.RequestStatus == StaticDetails.AppointmentScheduled)
                                            {
                                                <a asp-action="DoctorAppointmentDetails" asp-route-requestId="@request.Id"
                                                   class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                    <i class="fas fa-calendar-check me-1"></i> View Details
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>No Appointment Requests</h5>
                    <p class="mb-0">You don't have any pending appointment requests.</p>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .table {
        border-radius: 10px;
        overflow: hidden;
    }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--medical-primary);
            color: var(--medical-primary);
            white-space: nowrap;
        }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        white-space: nowrap;
    }

    .card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }

    .align-middle td {
        vertical-align: middle;
    }

    .dropdown-item.text-success:hover {
        background-color: rgba(25, 135, 84, 0.1);
    }

    .dropdown-item.text-danger:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        @if (TempData["Success"] != null)
        {
            <text>
                    Toast.fire({
                        icon: 'success',
                        title: '@TempData["Success"]'
                    });
            </text>
        }

        @if (TempData["Error"] != null)
        {
            <text>
                    Toast.fire({
                        icon: 'error',
                        title: '@TempData["Error"]'
                    });
            </text>
        }

        // Confirm before rejecting
        // document.querySelectorAll('[href*="RejectRequest"]').forEach(link => {
        //     link.addEventListener('click', function(e) {
        //         e.preventDefault();
        //         Swal.fire({
        //             title: 'Confirm Rejection',
        //             text: "Are you sure you want to reject this appointment request?",
        //             icon: 'warning',
        //             showCancelButton: true,
        //             confirmButtonColor: '#d33',
        //             cancelButtonColor: '#3085d6',
        //             confirmButtonText: 'Yes, reject it!'
        //         }).then((result) => {
        //             if (result.isConfirmed) {
        //                 window.location.href = `/Doctor/UserAppointmentResponses/RejectRequest?requestId=${requestId}`;
        //             }
        //         });
        //     });
        // });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmRejectance(requestId) {
            Swal.fire({
                title: 'Confirm Rejectance',
                text: "Are you sure you want to reject this appointment request?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, reject it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/Doctor/UserAppointmentResponses/RejectRequest?requestId=${requestId}`;
                }
            })
        }
    </script>

}